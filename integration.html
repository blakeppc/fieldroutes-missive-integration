<!DOCTYPE html>
<html>
<head>
    <title>FieldRoutes Integration</title>
    <script src="https://integrations.missiveapp.com/missive.js"></script>
    <link href="https://integrations.missiveapp.com/missive.css" rel="stylesheet">
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            padding: 16px; 
            margin: 0;
            background: #f8f9fa;
        }
        .card { 
            background: white;
            border: 1px solid #ddd; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 16px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .loading { 
            text-align: center; 
            color: #666; 
            padding: 20px;
        }
        .error { 
            color: #d73502; 
            padding: 12px; 
            background: #feebea; 
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success {
            color: #155724;
            padding: 12px;
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            margin: 10px 0;
        }
        input { 
            width: 100%; 
            padding: 10px; 
            margin: 8px 0; 
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 14px;
        }
        button { 
            background: #007bff; 
            color: white; 
            padding: 10px 20px; 
            border: none; 
            cursor: pointer; 
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            margin: 10px 0;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        
        .customer-info {
            background: white;
            border: 1px solid #28a745;
            border-radius: 6px;
            padding: 16px;
        }
        .customer-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 12px;
        }
        .customer-detail {
            display: flex;
            margin-bottom: 8px;
        }
        .detail-label {
            font-weight: 500;
            min-width: 80px;
            color: #666;
        }
        .detail-value { color: #333; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="app">
        <!-- Auth Section -->
        <div id="auth-section" class="card">
            <h3>üîó Connect to FieldRoutes</h3>
            
            <label>Your Server URL:</label>
            <input type="text" id="server-url" placeholder="https://your-repl-url.repl.co" value="">
            
            <label>FieldRoutes API URL:</label>
            <input type="text" id="api-url" value="https://ppclv.fieldroutes.com/api/v1">
            
            <label>API Key:</label>
            <input type="text" id="api-key" placeholder="Your API Key">
            
            <label>API Token:</label>
            <input type="password" id="api-token" placeholder="Your API Token">
            
            <button onclick="testAndConnect()">üß™ Test & Connect</button>
            
            <div id="connection-status"></div>
        </div>
        
        <!-- Main Section -->
        <div id="main-section" class="hidden">
            <div class="card">
                <h3>üîç Customer Search</h3>
                <input type="text" id="search" placeholder="Enter email, phone, or name...">
                <button onclick="searchCustomer()">Search Customer</button>
            </div>
            <div id="customer-results"></div>
        </div>
    </div>

    <script>
        let config = {};
        
        window.addEventListener('load', async function() {
            try {
                const savedConfig = await Missive.storeGet('fieldroutes_config');
                if (savedConfig) {
                    config = JSON.parse(savedConfig);
                    // Pre-fill form
                    document.getElementById('server-url').value = config.serverUrl || '';
                    document.getElementById('api-url').value = config.apiUrl || '';
                    document.getElementById('api-key').value = config.apiKey || '';
                    // Don't pre-fill password for security
                    
                    showMainSection();
                    loadCurrentCustomer();
                }
            } catch (error) {
                console.log('No saved config');
            }
        });
        
        async function testAndConnect() {
            const serverUrl = document.getElementById('server-url').value.trim();
            const apiUrl = document.getElementById('api-url').value.trim();
            const apiKey = document.getElementById('api-key').value.trim();
            const apiToken = document.getElementById('api-token').value.trim();
            
            if (!serverUrl || !apiUrl || !apiKey || !apiToken) {
                showStatus('error', 'Please fill in all fields');
                return;
            }
            
            config = { serverUrl, apiUrl, apiKey, apiToken };
            
            showStatus('loading', 'üß™ Testing connection...');
            
            try {
                const response = await fetch(`${serverUrl}/test-connection`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        apiUrl: apiUrl,
                        apiKey: apiKey,
                        apiToken: apiToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    await Missive.storeSet('fieldroutes_config', JSON.stringify(config));
                    showStatus('success', '‚úÖ Connection successful!');
                    setTimeout(showMainSection, 1500);
                } else {
                    showStatus('error', `‚ùå ${result.error}: ${result.details}`);
                }
                
            } catch (error) {
                showStatus('error', `‚ùå Server connection failed: ${error.message}`);
            }
        }
        
        async function searchCustomer() {
            const query = document.getElementById('search').value.trim();
            if (!query) return;
            
            document.getElementById('customer-results').innerHTML = 
                '<div class="card"><div class="loading">üîÑ Searching...</div></div>';
            
            try {
                const response = await fetch(`${config.serverUrl}/search-customer`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        query: query,
                        apiUrl: config.apiUrl,
                        apiKey: config.apiKey,
                        apiToken: config.apiToken
                    })
                });
                
                const result = await response.json();
                
                if (result.success && result.customer) {
                    showCustomer(result.customer);
                } else {
                    document.getElementById('customer-results').innerHTML = 
                        `<div class="card"><div class="error">üö´ ${result.message || 'No customer found'}</div></div>`;
                }
                
            } catch (error) {
                document.getElementById('customer-results').innerHTML = 
                    `<div class="card"><div class="error">‚ùå Search failed: ${error.message}</div></div>`;
            }
        }
        
        async function loadCurrentCustomer() {
            try {
                const conversation = await Missive.getCurrentConversation();
                const email = conversation?.contacts?.[0]?.email;
                if (email) {
                    document.getElementById('search').value = email;
                    await searchCustomer();
                }
            } catch (error) {
                console.log('Could not load current conversation');
            }
        }
        
        function showCustomer(customer) {
            const html = `
                <div class="card customer-info">
                    <div class="customer-name">
                        üë§ ${customer.firstName || ''} ${customer.lastName || customer.name || 'Customer'}
                    </div>
                    <div class="customer-detail">
                        <span class="detail-label">üìß Email:</span>
                        <span class="detail-value">${customer.email || 'N/A'}</span>
                    </div>
                    <div class="customer-detail">
                        <span class="detail-label">üìû Phone:</span>
                        <span class="detail-value">${customer.phone || customer.phoneNumber || 'N/A'}</span>
                    </div>
                    <div class="customer-detail">
                        <span class="detail-label">üè† Address:</span>
                        <span class="detail-value">${formatAddress(customer.address || customer.serviceAddress)}</span>
                    </div>
                    <div class="customer-detail">
                        <span class="detail-label">üìä Status:</span>
                        <span class="detail-value">${customer.status || customer.accountStatus || 'Active'}</span>
                    </div>
                </div>
            `;
            document.getElementById('customer-results').innerHTML = html;
        }
        
        function formatAddress(address) {
            if (!address) return 'N/A';
            if (typeof address === 'string') return address;
            const parts = [address.street, address.city, address.state, address.zip].filter(Boolean);
            return parts.join(', ') || 'N/A';
        }
        
        function showMainSection() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
        }
        
        function showStatus(type, message) {
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
    </script>
</body>
</html>
